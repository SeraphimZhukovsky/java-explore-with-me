{
  "info": {
    "name": "Comments API Tests",
    "description": "Тесты для проверки функциональности комментариев",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8080"
    }
  ],
  "item": [
    {
      "name": "Создание тестового пользователя",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"Test User\",\n  \"email\": \"test@example.com\"\n}"
        },
        "url": "{{baseUrl}}/admin/users"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Пользователь создан\", function () {",
              "    pm.response.to.have.status(201);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('id');",
              "    pm.collectionVariables.set(\"userId\", jsonData.id);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Создание категории",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"Test Category\"\n}"
        },
        "url": "{{baseUrl}}/admin/categories"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Категория создана\", function () {",
              "    pm.response.to.have.status(201);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('id');",
              "    pm.collectionVariables.set(\"categoryId\", jsonData.id);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Создание события для комментариев",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"title\": \"Test Event\",\n  \"annotation\": \"Тестовое событие для проверки комментариев\",\n  \"description\": \"Описание тестового события для функциональности комментариев\",\n  \"category\": {{categoryId}},\n  \"eventDate\": \"2025-12-31 15:00:00\",\n  \"location\": {\n    \"lat\": 55.7558,\n    \"lon\": 37.6173\n  },\n  \"paid\": false,\n  \"participantLimit\": 0,\n  \"requestModeration\": false\n}"
        },
        "url": "{{baseUrl}}/users/{{userId}}/events"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Событие создано\", function () {",
              "    pm.response.to.have.status(201);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('id');",
              "    pm.collectionVariables.set(\"eventId\", jsonData.id);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Публикация события",
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"stateAction\": \"PUBLISH_EVENT\"\n}"
        },
        "url": "{{baseUrl}}/admin/events/{{eventId}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Событие опубликовано\", function () {",
              "    pm.response.to.have.status(200);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.state).to.eql('PUBLISHED');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Добавление комментария",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"Отличное мероприятие! Очень понравилось организация и атмосфера.\"\n}"
        },
        "url": "{{baseUrl}}/users/{{userId}}/events/{{eventId}}/comments"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Комментарий создан\", function () {",
              "    pm.response.to.have.status(201);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('id');",
              "    pm.expect(jsonData.state).to.eql('PENDING');",
              "    pm.collectionVariables.set(\"commentId\", jsonData.id);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Получение комментариев пользователя",
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/users/{{userId}}/comments?from=0&size=10"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Комментарии пользователя\", function () {",
              "    pm.response.to.have.status(200);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.be.an('array');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Модерация комментария - подтверждение",
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"state\": \"CONFIRMED\",\n  \"moderatorComment\": \"Комментарий соответствует правилам\"\n}"
        },
        "url": "{{baseUrl}}/admin/comments/{{commentId}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Комментарий подтвержден\", function () {",
              "    pm.response.to.have.status(200);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.state).to.eql('CONFIRMED');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Публичные комментарии события",
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/events/{{eventId}}/comments?from=0&size=10"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Публичные комментарии\", function () {",
              "    pm.response.to.have.status(200);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.be.an('array');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Создание второго комментария",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"Второй комментарий для тестирования\"\n}"
        },
        "url": "{{baseUrl}}/users/{{userId}}/events/{{eventId}}/comments"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Второй комментарий создан\", function () {",
              "    pm.response.to.have.status(201);",
              "    const jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"commentId2\", jsonData.id);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Обновление комментария",
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"Обновленный текст комментария\"\n}"
        },
        "url": "{{baseUrl}}/users/{{userId}}/comments/{{commentId2}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Комментарий обновлен\", function () {",
              "    pm.response.to.have.status(200);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.state).to.eql('PENDING');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Модерация - отклонение комментария",
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"state\": \"REJECTED\",\n  \"moderatorComment\": \"Нарушение правил\"\n}"
        },
        "url": "{{baseUrl}}/admin/comments/{{commentId2}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Комментарий отклонен\", function () {",
              "    pm.response.to.have.status(200);",
              "    const jsonData = pm.response.json();",
              "    pm.expect(jsonData.state).to.eql('REJECTED');",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Проверка валидации - короткий текст",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"Кр\"\n}"
        },
        "url": "{{baseUrl}}/users/{{userId}}/events/{{eventId}}/comments"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Валидация короткого текста\", function () {",
              "    pm.response.to.have.status(400);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Удаление комментария",
      "request": {
        "method": "DELETE",
        "url": "{{baseUrl}}/users/{{userId}}/comments/{{commentId2}}"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Комментарий удален\", function () {",
              "    pm.response.to.have.status(204);",
              "});"
            ]
          }
        }
      ]
    }
  ]
}